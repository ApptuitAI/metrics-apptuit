#
#  Copyright 2017 Agilx, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

language: java
sudo: false

env:
  global:
    - secure: Opc5TWNibdokNCbOVNXXQXylqzUI5Vpg7Ntkl6qjEHPV5VsKMqaRuS57R8ydGLOx3wgys6JTJRXN3OMDr5T/wRwVpwDi3fsrhCxdcMGr+v6g9W60MmH26bVFNpnz1P85wUPOdeA0YQQOz7DjXRp/Y/+xYj+0udsRgx6TOCvPfyE6EMNedj8jWuhR4gw/PGQ/aUMC4aKd06IdIMpKax+jBA+kPLDYMZVM+m+aH49pNnnKVKg+HnJSyKg62yhUml1IljGc893nNQE30o9I6L6aRilXaNA/SPQkjzU106hjd6Q2QXEwP2QNrYoOl7Ad/vrtRHkBcjGzcvjnomPGYrK/bkhb2s65J8BxCrxVnbn5PC6YM8BKBTY6Zz30PVtNH3bnrSK/COjLb2U78lem0gIiGeFK75mZCC2aDbQyjqDN1U81M2i73fcQCH9z3R/ORVyex8eOjGDckjpI/oySLJRNOTBuV5OrvwEXVG+1D3qhioZJVMO68oWgP5ggx3Pd7VBculCTHtLRbs02ntv8/22kwbe13xq88DzZbLAPzKAOH1gP1FBgD81RO9lUnQd/w7ORHwEjXte5JQAKrpJ+xekMX3f70ELI3bveNTyaUrXRzI/DU3owki4csFWRYpBIh370HysBf5pke2oKyqiKQslTQr35OKaS2OOEJd9eEy0/0A0=
    - secure: hLIzmbokSkafJ3DtvIoBOmzCuLPf8raEupsAz1vmfXRUdpT48dFaUbDLDgfrzZbRYOL1n4dJC24FU3K3CU9UEZV4lw96a1mPnhT80bxw0UqaE5WoORhW9UNJ4szwnzwfQIR+sfiFrGk5qpABVk9Ygq4U0AeV3OpnQ1KYJFMxtmEDoTt4MQ1PA4qU1uF0xF80+qoJCwmuLrX4WHR0MwL0BiDCwjJOnaZMAkqtsqRbiWpzf/2e44LPasDw/l34vS4quuAWNW+PDgJtBsKZTY1jEn6CtbBQS0KykcwG+Q4Kmir5WnMwzOss+3SSjxqH9W2FOZGxxwnXWAyw/5NVAi3ujbq0I+vt7VhfpgD7KLisbC0sm08F2A3PxawJGwKdQjcNFNoQgsDZcIVVczDM9He7+uS2twiOYI+wQtxyyjrtxFy9y+Z+5rHxtFS0HNNp2iItrOlIsMPKlXw66usT1YCYIDqhy51ZF2ESdlZcIMOg78LobJjU4MIOcZE6gw5qjey+Ndl3AJ65td72Ue1D3duKxsagLCnGoj5THy9BT4EutM0JFh1+5B0hoGGhcnzuOwI0l5ksxYMtunZrIhYvvMG9Lz+LDWYvQMEmpFZvkAVYSVGZnNWBCzXLc3WCjNlqhf/TLqKzOoR57KlzDLApQWMoRvFpzqRSo7cIW1Sq1+fTVqs=
    - secure: DdSo7259Ci61uw5xe0cftkEQDC1Juz6MBPDCR7xSgqOmxJIQRW+iBFFe/P71rPvH9HmJslBFjyDP0l4GsF9LFh7DQLgDOwhi+D50vBVfp7w0qwne69u2HYT5+yMTyidyMDbuP+El9iVbS7WSJRWpPYY7abbMuR/2WpkXJmnwRZjjf9qo4Asb4hbTktKTsHtGll+JL2O6rK8ZuV8GQqDQFCms7fQh8zphNnRmC2yPUCK/p3Zuwrbn9QnpyfXUhoBDdL+gSmX+EZlit5dc+pBBXMlN4p9R6dXbUoSwzw5mhPPEbZGZVw3MhRjEOt0TDCArHOFjcqEcRBmlaCMbbqKOvndsJCScxfsjqetbQdki5OqeMJel0v5ZLCgPtuLCK3FnAlIAimLhs+pxEKwAmr+06YcQb9/2esuA6pFpbOL26KIRFKJrHaqc1egUHasOHg81KotwyJSotj8+kL7qDSj9Zvhgxc9xOXEQGdbZkpXJwEepGq9I1qvYZW9gcKQzNoueoFxkdXYt7Epk9+yKzrr4E4ZGg1NNDobUxnSulh2qjBr7tYO2ZwR+U60Zwq3P66hpGQ8Vd6ZmFAa2oIXsJCDQbADWCQd8+YIak9FL585FFCNLA5VYzeNoAeqlflaG5Bp+QRR8elHCAskhbjKAhIuaNbh1ym8IsZGllacdMFH39Ew=
  matrix:
    - METRICS_VERSION=3.1.0
    - METRICS_VERSION=3.2.6
    - METRICS_VERSION=4.0.2
    - METRICS_VERSION=4.1.0

jdk:
  - openjdk8

services:
  - memcached
  - redis

addons:
  sonarcloud:
    organization: "$SONAR_ORG"

cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.sonar/cache'
    - '$HOME/.codacy/reporter'

before_install:
  - |
    if [[ "$TRAVIS_PULL_REQUEST" = "false" ]]; then
      openssl aes-256-cbc -K $encrypted_8ef7f618d741_key -iv $encrypted_8ef7f618d741_iv -in conf/signingkey.asc.enc -out conf/signingkey.asc -d
    fi
  - sudo apt-get install -qq -y jq
  - wget -nv -O ~/.codacy/reporter/codacy-reporter-latest.jar https://oss.sonatype.org/service/local/repositories/releases/content/com/codacy/codacy-coverage-reporter/4.0.1/codacy-coverage-reporter-4.0.1-assembly.jar

install:
  - sudo apt-get -qq update
  - sudo apt-get install -qq -y xmlstarlet

before_script:
  - if [[ "$METRICS_VERSION" = "3.2.6" ]]; then export IS_PRIMARY_MATRIX_JOB=true; fi
  - xmlstarlet ed --inplace -u "/_:project/_:properties/_:metrics.version" -v "$METRICS_VERSION" pom.xml;
  - SEMVER_REGEX="^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(\-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$"
  - |
    if [[ "$TRAVIS_TAG" =~ $SEMVER_REGEX ]]; then
      export PACKAGE_VERSION=${TRAVIS_TAG#v};
      xmlstarlet ed --inplace -u "/_:project//_:properties/_:revision" -v "$PACKAGE_VERSION" pom.xml;
    fi
  - echo $TRAVIS_TAG
  - echo $PACKAGE_VERSION
  - echo $IS_PRIMARY_MATRIX_JOB

script:
  - |
    if [[ "$SONAR_ENABLED" = "true" ]] && [[ "$TRAVIS_PULL_REQUEST" = "false" ]] && [[ "$IS_PRIMARY_MATRIX_JOB" = "true" ]]; then
      mvn verify sonar:sonar -Denv.server.ip=127.0.0.1 -B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
    else
      mvn verify -Denv.server.ip=127.0.0.1 -B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
    fi

after_success:
  - |
    if [[ "$IS_PRIMARY_MATRIX_JOB" = "true" ]]; then
      bash <(curl -s https://codecov.io/bash);
      java -cp ~/.codacy/reporter/codacy-reporter-latest.jar com.codacy.CodacyCoverageReporter -l Java -r target/site/jacoco/jacoco.xml;
    fi
  - gpg2 --keyring=$TRAVIS_BUILD_DIR/pubring.gpg --no-default-keyring --import conf/signingkey.asc
  - gpg2 --allow-secret-key-import --keyring=$TRAVIS_BUILD_DIR/secring.gpg --no-default-keyring --import conf/signingkey.asc
deploy:
  - provider: script
    script: mvn -s conf/maven-settings.xml deploy -DskipTests -B
      -Dgpg.executable=gpg2 -Dgpg.keyname=A452BB8DE82F7D80A96505E3AF1DC1208A6106B5
      -Dgpg.passphrase=$PASSPHRASE -Dgpg.publicKeyring=$TRAVIS_BUILD_DIR/pubring.gpg -Dgpg.secretKeyring=$TRAVIS_BUILD_DIR/secring.gpg
      -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
      -Dsonar.projectKey=${SONAR_PROJECT} -Dsonar.login=${SONAR_TOKEN}
    skip_cleanup: true
    on:
      tags: true
      condition: $PACKAGE_VERSION != "" && $IS_PRIMARY_MATRIX_JOB == "true" && $BINTRAY_API_KEY != ""