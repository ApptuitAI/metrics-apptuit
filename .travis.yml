#
#  Copyright 2017 Agilx, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

dist: bionic
language: java
sudo: false

env:
  global:
    - secure: LL9gEckttGqGvwR/lGE/VHBjhHRAUzTa4bJ6oSs5brOINXEo5lCoxg5NSn/lhkq7B+3Iujw6rZ59aV8oqP1QovUOYw2f6kQqF+HHXQYETD/lqdCjBiDiT501aF7mBLk8wgRgJKIsSVmzwLNf3lwrdRcJeN2D8eGR7NlOn7vD8+2xVSNGVDK6x9u0OqHN/E5vdDUy8quUroNoGG4s639FrOZK5B1QQZczIoWeMM3cfPfx6g9NZQxEMAcQQjgXJoxyOZSj4QJvST0+RLacSf87CCOemNLlA+ZVF3cZJPkhq4gK4RLjn5VnmvZb0Iq+PWYTPy/VWSFCP6aEpL6HaXOC5ipU2OeNQkUGRSr8MGARLNpdlU53Eo33LWSyKyrJcySMp8aAk9fnyn2eE5eRPfzwBg48g57GNjmA3xRzMVZJi6FXUdB8zYk1b6rNpOYkTYzSy7MIIckW6P5bSAa6WX6YoScctonuzORZIx5S3gs8BW3OTmrc2LxjsIQIoAThtCNe0jhP4LdU0KBQNu0YxyW6JMQ2s1ujqigC4l23EWgIHPYR+qDz92i4P/rWIjK0nrO9MJCrb8G0MdaXrSA7yNH/Wk2HoMW3hTdsCSS7Y75AX0Ssk+SIP9BQCtZ3a9uwKXuYkoVlGg7CDqA8fttf9wwfJw3jG5uiLX7Ef7/BwcazH/o=
    - secure: RqOatgZe31zuyZ5z2/yyzTL5anIJUv6zAno1UF3BHiwBHev6cVuYP1AL52Mv3javC0LJ3L/9EzjmrJvrFbMUM61TkAdU8q/JRok4MramYY0iorCNY5x04cTBrJE/Fe/KZk4S0V8Q2wJlA/G5hcUIzzl8/MnxoL+uDeA+O1eVqHJkqCCRjT8I7BMKpO6XD0RW0voq/PO81FC5ERZF6WwwThYCtq092O9p+c2n66kbVCA8HKdilUQcvaXhIWUkA6DXSCOLOvbCEz4T3d/cCyBhFLhWSoonBPYN89PemyV5siaJoB97RiaukT4kxA4hHMWAPHgi6wqVKi898v6peMBxY9u7hfjxJgapEANwKEUkioSvLaU/gm/6hEtmhyGrZXqZ48qvwQ5n/fkXNRpS0CKqytDcodDXnk2d1+pJo6MLqXBgfI0D8/g173D+UV7V89u/q0zX0zkw28Sph0uDU31Wn4WxYfaM1z++uilH5d2mZLyAfoTLqPjkz9qMoJCepEkDVjzDPJT03BIefH1vK27G453laaGZxURBsa00xssrIu3RL2GZH1+c+4vVkiknSqYDPhUdXfQtkbzaNzDKjlnyAXBJm9dSS06uYnlJr4/6je+0/0fJJN19ZCQrc3SLWF9OrwUIoIaZesqZ30x4zUTBLjCNTyVOkW5MhkO8HgHYVmA=
    - secure: M8RfG/kI0pdbV9RZu1mThVkjcM3AJCeIskh6IMnSB6Xg6jKydUCXQBOWZmi1wtiAAxmKbCU3c6VkqxgMAqCLDFzWpP3iL8Dhq5rqyKZR5UFBb9EUYayDO9gusF5TXWrqdrVPYiLuqlIvZ3hdGyDibSOylEwScKjjbcerXbz7PxMFn0ZdnElyiBHGrq96/UIXc4y7iiZdCKT7mWBXqPnrxLL3slPcJew12jPhkpzMGXYb+uAz4jgHcD1pbyaYkQ5QsJ7uTtzBv3r1deHC2BtUnYtGjn1oQV2nKwrAafL5BCXBi5FjlmkETaGZenBJxqPXDGPVJZ0GV6SvnoC6ldNlTCK3tit2dRgeY9pFHemcEMFEdg1k/Me8NSmAwnTpZOYghUtAVkGW9QjBYWTCTQbuy1ZD1kfP2O+k1jwbeHDkYRb9O4ynaexecLhSLQLEwASrfanL+z0W/vY9o5BwyU4D0LiwE3OuLf+ypuDvw5xqkzuWRDc41ELlcUYR/eZXg6nHb28tE2xF4I50xvf4DZY02NXvCaCEP0TsJWMtqUE1pnSVE0/esk9pWmifyLVJ9auyED5DBfgrT9zQhCYm7VjC/FkfuQ4dpbGJxfoPxfVA9y9skNnQusuHQyySRntR2tqcPZ2n68vJZhVUFeaIq7QqDhNExVdTDxQ1ti1+oltYQt4=
  matrix:
    - METRICS_VERSION=3.1.0
    - METRICS_VERSION=3.2.6
    - METRICS_VERSION=4.0.2
    - METRICS_VERSION=4.1.0

jdk:
  - openjdk8

services:
  - memcached
  - redis

addons:
  sonarcloud:
    organization: "$SONAR_ORG"

cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.sonar/cache'
    - '$HOME/.codacy/reporter'

before_install:
  - sudo apt-get install -qq -y jq
  - wget -nv -O ~/.codacy/reporter/codacy-reporter-latest.jar https://oss.sonatype.org/service/local/repositories/releases/content/com/codacy/codacy-coverage-reporter/4.0.1/codacy-coverage-reporter-4.0.1-assembly.jar
  - |
    if [[ "$encrypted_60ba2f79b530_key" != "" ]]; then
      openssl aes-256-cbc -K $encrypted_60ba2f79b530_key -iv $encrypted_60ba2f79b530_iv -in conf/signingkey.asc.enc -out conf/signingkey.asc -d;
      gpg2 --batch --keyring=$TRAVIS_BUILD_DIR/pubring.gpg --no-default-keyring --import conf/signingkey.asc;
      gpg2 --batch --allow-secret-key-import --keyring=$TRAVIS_BUILD_DIR/secring.gpg --no-default-keyring --import conf/signingkey.asc;
      gpg2 --version
    fi

install:
  - sudo apt-get -qq update
  - sudo apt-get install -qq -y xmlstarlet

before_script:
  - if [[ "$METRICS_VERSION" = "3.2.6" ]]; then export IS_PRIMARY_MATRIX_JOB=true; fi
  - xmlstarlet ed --inplace -u "/_:project/_:properties/_:metrics.version" -v "$METRICS_VERSION" pom.xml;
  - SEMVER_REGEX="^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(\-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$"
  - |
    if [[ "$TRAVIS_TAG" =~ $SEMVER_REGEX ]]; then
      export PACKAGE_VERSION=${TRAVIS_TAG#v};
      xmlstarlet ed --inplace -u "/_:project//_:properties/_:revision" -v "$PACKAGE_VERSION" pom.xml;
    fi
  - echo $TRAVIS_TAG
  - echo $PACKAGE_VERSION
  - echo $IS_PRIMARY_MATRIX_JOB
  - export COMMON_MVN_FLAGS="-Dgpg.executable=gpg2 -Dgpg.keyname=8A6106B5 -Dgpg.passphrase=$PASSPHRASE
    -Dgpg.publicKeyring=$TRAVIS_BUILD_DIR/pubring.gpg -Dgpg.secretKeyring=$TRAVIS_BUILD_DIR/secring.gpg
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN"

script:
  - |
    if [[ "$SONAR_ENABLED" = "true" ]] && [[ "$TRAVIS_PULL_REQUEST" = "false" ]] && [[ "$IS_PRIMARY_MATRIX_JOB" = "true" ]]; then
      mvn verify sonar:sonar -Denv.server.ip=127.0.0.1 -B $COMMON_MVN_FLAGS
    else
      mvn verify -Denv.server.ip=127.0.0.1 -B $COMMON_MVN_FLAGS
    fi

after_success:
  - |
    if [[ "$IS_PRIMARY_MATRIX_JOB" = "true" ]]; then
      bash <(curl -s https://codecov.io/bash);
      java -cp ~/.codacy/reporter/codacy-reporter-latest.jar com.codacy.CodacyCoverageReporter -l Java -r target/site/jacoco/jacoco.xml;
    fi

deploy:
  - provider: script
    script: mvn -s conf/maven-settings.xml deploy -DskipTests -B $COMMON_MVN_FLAGS
      -Dsonar.projectKey=${SONAR_PROJECT} -Dsonar.login=${SONAR_TOKEN}
    skip_cleanup: true
    on:
      tags: true
      condition: $PACKAGE_VERSION != "" && $IS_PRIMARY_MATRIX_JOB == "true" && $BINTRAY_API_KEY != ""
