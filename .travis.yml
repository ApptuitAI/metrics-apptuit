#
#  Copyright 2017 Agilx, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

language: java
sudo: false

env:
  global:
    - secure: CJpvNc6hrDgz/JVhwo6/aAm3aYeYVScxS8Cxaaxru6xoaoccPP8qTAkadkm4Y7900b8G75/19SAgo5e46X9nGwe7yz9VPkEx0Ju77aPdYihfGB1HJfAKaVIQVUKoRa+BkMeSXNu2p+iexblvKXkVI2GN9S6EzmV/Hz92rCIkWYr7qD3VoVIFTConPKRQxiQPTloB5Re1dJ2clVu9y003MWnjTzhQnnIBbj73d9sqitwnLe/bXv4bOktmfW1AM+NiihhGw1oZpsAYaq4RzfMZJT91N60dmon+MHPvEjIMOwVVShSFBcYwH5mtYbuEDmKpsnvH66QmSjdzX6rn2w9WtfXJG5rLLOAbJYrKDujMHk8PgrqjPJkEdb0ayRRS6W9plhRD1mkSFsIIpqjfdm3blM281h9nmN3vqGq82Pt8Qz0D+bivkWWsrvsLjbtw23EnK59owAmB/oei6ZY2jwSqkDR30IT8RaRh0BCtL0cw1XSgp2s8Q82G9oa5PkRvG2/uiAL3xCXg373eiR+l/j429nkUO2B3seEetTF7oha2NgzFFwTOJl4P+eNfXh3BSzadAjzi4Bpb+hvlcDYamHz+6x0LhF8GmE9gr3nyP1ot/skauCZqvdjZv8OhUybleIiLCC1sUxdG6JojgY5nvuLB9Dw6SCs0QeP4hF7qK4cMNPE=
    - secure: kAUsJv4e5v5AKjg6wxve7F0jfe9Y6902htSwe9hEWKSbQnQCD2uk6slENS/k9TuJSyKvkw1EvqXGISDELYratGHA1Nhof1++TMXybhLOsc73i+9U66swQ4u35sjhAwqG3MIfdpndEay1UeLXd6c9l6fh8hXjBEXTAcMhcqGIX0zGUSdVxSq2fw43OiqlGyqwHyyrTrVTYy8H9SICRVRR5Ntu4gJ8pP9UZR3rywijpdKe0baxuzd0elDB51J/F2uYeiyYs7zTK/kOSdssaZQqXRBjy6zPHoEBRDqjFqrxzRf4+RcPSgsI7veFmdUGGfTJXsb5XCVMiZSMKtCJy69LPEzoLywFEWD1xuuwDnHid9mkJLTxIPpuG5OUBJnVbgpRWb+BNqBK7wpor3nw4iAgYyjVJ38Qvsp4ZDacHuFSpUmqhC5Mn0omIaWWjPPaI1b1/i08dSPtyx2a1R7RuB8yZlyPu9La4lcqp60fedCKAB5swFAFsJzJOM5EICLokfH35AjHzrgcjYHc8MNMykiiAgl0f4gQqlhQXGD9CdpIJYpbwVJQ70cpTYj+kWaKmnB2jmzXh+m3MV4muoJkb8JkhSsX/Otm4hsgfkmlJEMbkBaR5sLJLqNgUBW0AWwlv12Bvlt2ZkGDgmhCa6moMbKYkqQ/Noc+VZ2HXnxtat4Pngw=
    - secure: i/Fe9hnfBHVcIGZQLTE4GOsz6+lRMGO9s7H8Zs1LXs9VMPHlalHX9n1Rlh6y2OqEva1fVNGyJCm3qZAgMaNcKh7e9EJjiUKYYaxZjcFgQeH09A1n7E0vr1xl0KviWl9hX2pOeDVmk+TZXIg/7ZUB8AJftEqaqnooSccZ4NiWE6M172g1fYU58+ptoI4yYfeU+chcp9dz7W6wuNXinLeeOLDtmbwWS+s3I+Z20itdei7aBSfsrZaYgAj6i8tCrB/Qs0p9WFWX/78aCOCJ7L1bETlqNmRZo7JZ3ZFLghXH3ipwFOBpYpW1eDVaFerDotVUXdrYNZCUmfHddoJPpOl3G5CBw34rkJRsgqaCeq10p0tQHIlO/Fd8TvEnqdE8yr6hyFnKbCuGInaZLB7lNrjC7bgXvprFUYT2ewPbR2e2wYXX3bWUKQERFtT5stFjIN8oaZI2dUJzzwhNdKDMMJ38KW/1xfzdc/lss9zud4sceD/pAPro6RAaNW3N9HiMkDHtx721QD2tpmVqdrkpk2dVbZfNuFpEGMWIb7bsT7dOKxV1U4wGI/Elvgz9tHTwclI/G8QG7o5OsJY45AjnNC+jGq6WC6X1vcYCqQkBanpz7XyJ1T71Q6SC26hSrDZkttCjadcMFVe0wvN2eYPgFEWkikgfFjlqye4Fg9+gzk34sAo=
  matrix:
    - METRICS_VERSION=3.1.0
    - METRICS_VERSION=3.2.6
    - METRICS_VERSION=4.0.2
    - METRICS_VERSION=4.1.0

jdk:
  - openjdk8

services:
  - memcached
  - redis

addons:
  sonarcloud:
    organization: "$SONAR_ORG"

cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.sonar/cache'
    - '$HOME/.codacy/reporter'

before_install:
  - sudo apt-get install -qq -y jq
  - wget -nv -O ~/.codacy/reporter/codacy-reporter-latest.jar https://oss.sonatype.org/service/local/repositories/releases/content/com/codacy/codacy-coverage-reporter/4.0.1/codacy-coverage-reporter-4.0.1-assembly.jar
  - sudo apt-get install -qq -y openssl
  - sudo apt-get install -qq -y gnupg2
  - |
    if [[ "$encrypted_60ba2f79b530_key" != "" ]]; then
      openssl aes-256-cbc -K $encrypted_60ba2f79b530_key -iv $encrypted_60ba2f79b530_iv -in conf/signingkey.asc.enc -out conf/signingkey.asc -d;
      gpg2 --keyring=$TRAVIS_BUILD_DIR/pubring.gpg --no-default-keyring --import conf/signingkey.asc;
    fi

install:
  - sudo apt-get -qq update
  - sudo apt-get install -qq -y xmlstarlet

before_script:
  - if [[ "$METRICS_VERSION" = "3.2.6" ]]; then export IS_PRIMARY_MATRIX_JOB=true; fi
  - xmlstarlet ed --inplace -u "/_:project/_:properties/_:metrics.version" -v "$METRICS_VERSION" pom.xml;
  - SEMVER_REGEX="^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(\-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$"
  - |
    if [[ "$TRAVIS_TAG" =~ $SEMVER_REGEX ]]; then
      export PACKAGE_VERSION=${TRAVIS_TAG#v};
      xmlstarlet ed --inplace -u "/_:project//_:properties/_:revision" -v "$PACKAGE_VERSION" pom.xml;
    fi
  - echo $TRAVIS_TAG
  - echo $PACKAGE_VERSION
  - echo $IS_PRIMARY_MATRIX_JOB

script:
  - |
    if [[ "$SONAR_ENABLED" = "true" ]] && [[ "$TRAVIS_PULL_REQUEST" = "false" ]] && [[ "$IS_PRIMARY_MATRIX_JOB" = "true" ]]; then
      mvn verify sonar:sonar -Denv.server.ip=127.0.0.1 -B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
    else
      mvn verify -Denv.server.ip=127.0.0.1 -B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
    fi

after_success:
  - |
    if [[ "$IS_PRIMARY_MATRIX_JOB" = "true" ]]; then
      bash <(curl -s https://codecov.io/bash);
      java -cp ~/.codacy/reporter/codacy-reporter-latest.jar com.codacy.CodacyCoverageReporter -l Java -r target/site/jacoco/jacoco.xml;
    fi

deploy:
  - provider: script
    script: mvn -s conf/maven-settings.xml deploy -DskipTests -B
      -Dgpg.executable=gpg2 -Dgpg.keyname=A452BB8DE82F7D80A96505E3AF1DC1208A6106B5
      -Dgpg.passphrase=$PASSPHRASE -Dgpg.publicKeyring=$TRAVIS_BUILD_DIR/pubring.gpg -Dgpg.secretKeyring=$TRAVIS_BUILD_DIR/secring.gpg
      -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
      -Dsonar.projectKey=${SONAR_PROJECT} -Dsonar.login=${SONAR_TOKEN}
    skip_cleanup: true
    on:
      tags: true
      condition: $PACKAGE_VERSION != "" && $IS_PRIMARY_MATRIX_JOB == "true" && $BINTRAY_API_KEY != ""
